<!DOCTYPE html>

<html lang="en">  
    <head>
        <meta charset="UTF-8">
        <title>JaanChat</title>
        <link rel="stylesheet" href="styles/chatroom_style.css">   
    </head>  
    
    <body>
        <!-- Nickname -->
        <div id="nickname">
            <form id="nick-form">
                <input id="nick-input" autocomplete="off" autofocus placeholder="Please enter a nickname"/>
                <button id="nick-button" onclick="closeNicknameWindow()">Enter</button>
            </form>
        </div>
        
        <!--A list of users who are online--> 
        <p id="online-user-list"></p>

        <!--private messages-->
        <div id="private-message">
            <button id="private-message-button">Private Message</button>
            <div id="private-message-user-list"></div>
        </div>

        <!-- The messages go here -->
        <ul id="messages"></ul>   
        
        <!-- user is typing message -->
        <p id="user-typing"></p>

        <!-- message input and submit button --> 
        <form id="message-form" action="">     
            <p id="private-message-sending-to"></p>
            <input id="message-input" autocomplete="off" /> 
            <button type="submit" id="send">Send</button>    
            <button type="reset" id="cancel">Cancel</button>
        </form>
    </body>

    <script src="/socket.io/socket.io.js"></script>
    <script src="../node_modules/socket.io/socket.io.js"></script>
    <scricpt src="../node_modules/socket.io/client-dist/socket.io.js"></scricpt>

    <script>  
        let socket = io();

        // Nickname
        let nicknameWindow = document.getElementById("nickname"); // nickname window
        let nickname = null; //nickname chosen by the user
        let nickForm = document.getElementById('nick-form');
        let nickInput = document.getElementById('nick-input');
        let isNicknameChosen = false;

        function closeNicknameWindow(){
            nicknameWindow.style.display = "none";
            messageInput.focus();
            isNicknameChosen = true;
            document.getElementById("private-message").style.display = "block";
        }

        nickForm.onsubmit = function(e){
            e.preventDefault();
            if(!nickInput.value){
                nickname = 'Anonymous';
            }
            socket.emit('nickname', nickInput.value);
            nickname = nickInput.value;
        };

         
        // user is Online
        let usersOnline;
        socket.on('whoIsOnline',function(onlineUsers) {
            let whoIsOnlineMessage = "";
            usersOnline = onlineUsers;
            for(let i = 0; i < usersOnline.length; i++){
                if(whoIsOnlineMessage == ""){
                    whoIsOnlineMessage = "Users Online: " + usersOnline[i];
                }
                else{
                    whoIsOnlineMessage += ", " + usersOnline[i];
                }
            }
            
            document.getElementById("online-user-list").innerHTML = whoIsOnlineMessage;
        });

        // private messaging
        let isPrivateUserListVisible = false;
        let isPrivateMessageModeActive = false;
        let sendPrivateMessageTo;
        let privateMessageUserList = document.getElementById("private-message-user-list");
        let privateMessageUserButtons = document.getElementsByClassName("private_message_user_buttons");
        let privateMessageSendingToMessage = document.getElementById("private-message-sending-to");

        // when the Private Message at the top right corner of the screen is clicked
        document.getElementById("private-message-button").onclick = function(){
            privateMessageUserList.style.display = isPrivateUserListVisible ? "none": "block"; // toggle the list
            isPrivateUserListVisible = !isPrivateUserListVisible;

            // Remove all the useers from the list
            while(privateMessageUserButtons.length > 0){
                privateMessageUserButtons[0].remove();
            }

            // Add users back to the list, create a button for each online user
            for(let i = 0; i < usersOnline.length; i++){
                var privateButton = document.createElement("button");
                privateButton.innerText = usersOnline[i];
                privateButton.className = "private_message_user_buttons";
                privateMessageUserList.appendChild(privateButton);
            }

            // Check any click on the private message button and activate private message mode
            for(let i = 0; i < privateMessageUserButtons.length; i++){
                privateMessageUserButtons[i].onclick = function(){
                    privateMessageSendingToMessage.style.display = "inline";
                    privateMessageSendingToMessage.innerText = "Sending private message to " + privateMessageUserButtons[i].innerText + ":";
                    sendPrivateMessageTo = privateMessageUserButtons[i].innerText;
                    messageForm.style.backgroundColor = "rgba(255, 75, 75, 0.75)"; 
                    messageInput.style.backgroundColor = "rgba(255, 225, 225, 0.75)"; 
                    messageInput.focus();
                    privateMessageUserList.style.display = isPrivateUserListVisible ? "none": "block";
                    isPrivateUserListVisible = !isPrivateUserListVisible;
                    isPrivateMessageModeActive = true;
                };
            }
        };
        

        // cancel button, gets rid of any input and takes user out of private messsage mode
        document.getElementById("cancel").onclick = cancelPrivateMessageMode();
        
        function cancelPrivateMessageMode(){
            if(isPrivateMessageModeActive){
                privateMessageSendingToMessage.style.display = "none";
                messageForm.style.backgroundColor = "rgba(0, 0, 0, 0.15)"; 
                messageInput.style.backgroundColor = "white"; 
                isPrivateMessageModeActive = false;
            }
        }

        // normal messages
        let messageForm = document.getElementById('message-form');  
        let messageInput = document.getElementById('message-input');

        // Send Message
        messageForm.onsubmit = function(e) {    
            e.preventDefault();
            if (messageInput.value) {
                if(isPrivateMessageModeActive){ //send private message to user if the user is in private message mode
                    addUserMessage("Private Message Sent To " + sendPrivateMessageTo +": " + messageInput.value, true); // make it appear on the client screen
                    socket.emit("private message", sendPrivateMessageTo, messageInput.value); // send the message to the server
                    cancelPrivateMessageMode();
                } else{ // Normal Message
                    addUserMessage(nickname + ": " + messageInput.value, false);
                    socket.emit('chat message', messageInput.value);  
                }

                messageInput.value = '';
            }
            return false;  
        };


        // Receive Message
        socket.on('chat message', function(msg) {
            if(isNicknameChosen){   
                addUserMessage(msg, false);
            }
        });

        socket.on("private message", function(from, msg){
            if(isNicknameChosen){   
                addUserMessage("Private Message From " + from + " :" + msg, true);
            }
        });

        function addUserMessage(msg, isPrivate){
            let item = document.createElement('li');    
            item.textContent = msg;    
            messages.appendChild(item);    
            if(isPrivate){
                item.style.backgroundColor = "rgba(255, 75, 75, 0.75)";
            }
            window.scrollTo(0, document.body.scrollHeight);  
        }

        // User is typing
        let typingTimeout = null;
        let isUserTyping = false;

        messageInput.onkeypress = function(e){ // let the server know the user has started typing
            if(e.keyCode == 13 || isPrivateMessageModeActive){ // don't show the user is tytping for enter key and if the user is in private mode
                return;
            }

            clearTimeout(typingTimeout);

            if(!isUserTyping){ // check if the user is typing
                isUserTyping = true;
                socket.emit("typing", nickname);
            }

            typingTimeout = setTimeout(stoppedTypingTimeOut, 2000); // set a timeout in milliseconds, once it runs out let the server know the user has stopped typing
        }

        function stoppedTypingTimeOut(){ // let the server know the user has stopped typing
            socket.emit("not typing", nickname);
            isUserTyping = false;
        }

        let usersTypingSet = new Set(); // a set that stores the users that are typing
        socket.on("typing", function(name){ // add the users that are typing to the set here
            if(!usersTypingSet.has(name)){ 
                usersTypingSet.add(name);
                userIsTypingMessage(usersTypingSet); // update the message after the set has been changed
            }
        });

        socket.on("not typing", function(name){ // remove the user from set, update the message
            if(usersTypingSet.has(name)){
                usersTypingSet.delete(name);
                userIsTypingMessage(usersTypingSet);
            }
        });

        function userIsTypingMessage(userTyping){ 
            if (userTyping.size == 0){ // hide the message
                document.getElementById("user-typing").style.visibility = "hidden";
            } else{
                let typing = "";
                userTyping.forEach(key => typing = typing == "" ? typing += key : typing += ", " + key); // concatanate the set of users who are typing

                if(userTyping.size == 1){
                    document.getElementById("user-typing").innerHTML = "Following user is typing: " + typing;
                } else{
                    document.getElementById("user-typing").innerHTML = "Following users are typing: " + typing;
                }
                
                document.getElementById("user-typing").style.visibility = "visible";
            }
        };
    
    </script>
</html>